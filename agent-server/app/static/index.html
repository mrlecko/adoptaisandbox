<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CSV Analyst Chat</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 900px; }
    textarea, input, select { width: 100%; margin-top: .5rem; margin-bottom: 1rem; }
    table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: .25rem .5rem; }
    #status { color: #555; margin-bottom: .75rem; }
    pre { background: #f6f6f6; padding: .5rem; overflow-x: auto; }
    #messages { border: 1px solid #ddd; background: #fafafa; height: 320px; overflow-y: auto; padding: .75rem; margin-bottom: 1rem; }
    #thread-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
    #thread-id { color: #666; font-size: .9rem; }
    .msg-row { display: flex; margin: .35rem 0; }
    .msg-row.user { justify-content: flex-start; }
    .msg-row.assistant { justify-content: flex-end; }
    .msg-bubble { max-width: 75%; border-radius: 12px; padding: .5rem .75rem; white-space: pre-wrap; }
    .msg-bubble.user { background: #e9eefc; }
    .msg-bubble.assistant { background: #e7f6ea; }
  </style>
</head>
<body>
  <h1>CSV Analyst Chat (Minimal)</h1>
  <label>Dataset</label>
  <select id="dataset"></select>
  <div id="prompts"></div>
  <div id="thread-bar">
    <div id="thread-id"></div>
    <button id="new-thread" type="button">New conversation</button>
  </div>
  <h3>Messages</h3>
  <div id="messages"></div>
  <label>Message</label>
  <textarea id="message" rows="4" placeholder="Ask a question, SQL: SELECT ..., or PYTHON: result = ..."></textarea>
  <button id="send">Send</button>
  <div id="status"></div>
  <h3>Result</h3>
  <div id="result"></div>
  <h3>Details</h3>
  <pre id="details"></pre>
  <script>
    function randomThreadId() {
      if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      return 'thread-' + Math.random().toString(36).slice(2, 12);
    }

    function ensureThreadId() {
      let threadId = localStorage.getItem('csvAnalystThreadId');
      if (!threadId) {
        threadId = randomThreadId();
        localStorage.setItem('csvAnalystThreadId', threadId);
      }
      window.threadId = threadId;
      document.getElementById('thread-id').textContent = `Thread: ${threadId}`;
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }

    function appendMessage(actor, text) {
      const list = document.getElementById('messages');
      const row = document.createElement('div');
      row.className = `msg-row ${actor}`;
      const bubble = document.createElement('div');
      bubble.className = `msg-bubble ${actor}`;
      bubble.textContent = text;
      row.appendChild(bubble);
      list.appendChild(row);
      list.scrollTop = list.scrollHeight;
    }

    async function loadThreadHistory() {
      if (!window.threadId) return;
      const res = await fetch(`/threads/${window.threadId}/messages?limit=100`);
      if (!res.ok) return;
      const payload = await res.json();
      clearMessages();
      for (const msg of payload.messages || []) {
        if (msg.role === 'user' || msg.role === 'assistant') {
          appendMessage(msg.role, msg.content || '');
        }
      }
    }

    async function loadDatasets() {
      const res = await fetch('/datasets');
      const data = await res.json();
      const sel = document.getElementById('dataset');
      window.datasetMeta = {};
      sel.innerHTML = '';
      for (const ds of data.datasets) {
        window.datasetMeta[ds.id] = ds;
        const opt = document.createElement('option');
        opt.value = ds.id;
        opt.textContent = ds.id + ' - ' + ds.name;
        sel.appendChild(opt);
      }
      renderPrompts();
    }

    function renderPrompts() {
      const datasetId = document.getElementById('dataset').value;
      const promptsWrap = document.getElementById('prompts');
      promptsWrap.innerHTML = '';
      const ds = window.datasetMeta && window.datasetMeta[datasetId];
      if (!ds || !ds.prompts || ds.prompts.length === 0) return;
      const label = document.createElement('div');
      label.textContent = 'Suggested prompts:';
      promptsWrap.appendChild(label);
      for (const p of ds.prompts.slice(0, 4)) {
        const btn = document.createElement('button');
        btn.style.marginRight = '.5rem';
        btn.style.marginBottom = '.5rem';
        btn.textContent = p;
        btn.onclick = () => { document.getElementById('message').value = p; };
        promptsWrap.appendChild(btn);
      }
    }

    function renderTable(columns, rows) {
      if (!columns || columns.length === 0) return '<em>No rows</em>';
      function isMoneyColumn(colName) {
        const c = String(colName || '').toLowerCase();
        return /(revenue|price|amount|cost|total|sales|profit|discount)/.test(c);
      }
      function formatValue(colName, value) {
        if (value === null || value === undefined) return '';
        if (typeof value !== 'number') return String(value);
        if (Number.isInteger(value)) return String(value);
        if (isMoneyColumn(colName)) return value.toFixed(2);
        const asText = String(value);
        if (asText.includes('.') && asText.split('.')[1].length > 6) {
          return value.toFixed(6).replace(/0+$/, '').replace(/\.$/, '');
        }
        return asText;
      }
      let html = '<table><thead><tr>';
      for (const c of columns) html += `<th>${c}</th>`;
      html += '</tr></thead><tbody>';
      for (const r of rows) {
        html += '<tr>';
        for (let i = 0; i < columns.length; i++) {
          const col = columns[i];
          const v = i < r.length ? r[i] : null;
          html += `<td>${formatValue(col, v)}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      return html;
    }

    function updateFromPayload(data) {
      document.getElementById('status').textContent = `Status: ${data.status}`;
      appendMessage('assistant', data.assistant_message || '');
      document.getElementById('result').innerHTML = renderTable(data.result.columns, data.result.rows);
      document.getElementById('details').textContent = JSON.stringify(data.details, null, 2);
    }

    document.getElementById('send').onclick = async () => {
      const dataset_id = document.getElementById('dataset').value;
      const message = document.getElementById('message').value;
      if (!message.trim()) return;
      appendMessage('user', message);
      document.getElementById('message').value = '';
      document.getElementById('status').textContent = 'Streaming...';
      const res = await fetch('/chat/stream', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ dataset_id, message, thread_id: window.threadId }),
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        while (buffer.includes('\n\n')) {
          const idx = buffer.indexOf('\n\n');
          const chunk = buffer.slice(0, idx);
          buffer = buffer.slice(idx + 2);

          let eventName = '';
          let eventData = '';
          for (const line of chunk.split('\n')) {
            if (line.startsWith('event: ')) eventName = line.slice(7).trim();
            if (line.startsWith('data: ')) eventData = line.slice(6).trim();
          }
          if (!eventName || !eventData) continue;
          const parsed = JSON.parse(eventData);

          if (eventName === 'status') {
            document.getElementById('status').textContent = `Stage: ${parsed.stage}`;
          } else if (eventName === 'result') {
            if (parsed.thread_id) {
              window.threadId = parsed.thread_id;
              localStorage.setItem('csvAnalystThreadId', window.threadId);
              document.getElementById('thread-id').textContent = `Thread: ${window.threadId}`;
            }
            updateFromPayload(parsed);
          } else if (eventName === 'error') {
            appendMessage('assistant', parsed.message || 'Unknown error');
            document.getElementById('status').textContent = `Error: ${parsed.message || 'unknown'}`;
          }
        }
      }
    };

    document.getElementById('dataset').onchange = renderPrompts;
    document.getElementById('new-thread').onclick = async () => {
      window.threadId = randomThreadId();
      localStorage.setItem('csvAnalystThreadId', window.threadId);
      document.getElementById('thread-id').textContent = `Thread: ${window.threadId}`;
      clearMessages();
      document.getElementById('status').textContent = 'New conversation started.';
    };

    ensureThreadId();
    loadDatasets();
    loadThreadHistory();
  </script>
</body>
</html>
